name: "NetBackup: Java Maven Server Backup (No JAR Commit)"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup-java-maven-server:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Maven ì„¤ì¹˜
      - name: Install Maven 3.9.6
        run: |
          MAVEN_VERSION=3.9.6
          curl -sL https://downloads.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.zip -o maven.zip
          unzip -q maven.zip -d $HOME/apache-maven
          echo "MAVEN_HOME=$HOME/apache-maven/apache-maven-${MAVEN_VERSION}" >> $GITHUB_ENV
          echo "PATH=$HOME/apache-maven/apache-maven-${MAVEN_VERSION}/bin:$PATH" >> $GITHUB_ENV

      # ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ
      - name: Download Spring Boot project if missing
        run: |
          if [ ! -f "./pom.xml" ]; then
            echo "âš ï¸ pom.xml not found. Downloading spring-petclinic..."
            curl -L -o springboot.zip "https://github.com/spring-projects/spring-petclinic/archive/refs/heads/main.zip"
            unzip -q springboot.zip -d temp
            mv temp/spring-petclinic-main/* ./
            echo "âœ… Project downloaded."
          fi

      # ë¹Œë“œ
      - name: Build project
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true

      # ìŠ¬ë¡¯ ìƒì„±
      - name: Create .netbackup slot directory
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          echo "SLOT_DIR=.netbackup/slot-${TIMESTAMP}" >> $GITHUB_ENV
          mkdir -p "${SLOT_DIR}/target"
          mkdir -p "${SLOT_DIR}/config"
          echo "ğŸ“¦ Created backup slot: ${SLOT_DIR}"

      # íŒŒì¼ ë³µì‚¬
      - name: Copy project files to backup slot
        run: |
          cp pom.xml "${SLOT_DIR}/" || echo "âš ï¸ pom.xml not found"
          [ -d src ] && cp -r src "${SLOT_DIR}/" || echo "âš ï¸ src not found"
          [ -f target/*.jar ] && cp target/*.jar "${SLOT_DIR}/target/" || echo "âš ï¸ jar not found"
          [ -d src/main/resources ] && cp -r src/main/resources/* "${SLOT_DIR}/config/" || echo "âš ï¸ config not found"
          echo "âœ… Files copied to backup slot"

      # .gitignore íŒŒì¼ ìë™ ì‘ì„± (JAR ì œì™¸)
      - name: Create .gitignore to exclude large JAR files
        run: |
          echo "${SLOT_DIR}/target/*.jar" >> .gitignore
          echo ".netbackup/**/target/*.jar" >> .gitignore
          echo "âœ… .gitignore ì‘ì„± ì™„ë£Œ (JAR ì œì™¸)"

      # ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit and Push .netbackup (exclude JAR)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .gitignore
          git add .netbackup/ -u  # ìˆ˜ì •ëœ íŒŒì¼ë§Œ ì¶”ì  (JAR ì œì™¸)
          git commit -m "ğŸ“¦ NetBackup (no JAR) - $(date +'%Y-%m-%d %H:%M:%S')" || echo "â„¹ï¸ Nothing to commit"
          git push origin HEAD:${{ github.ref_name }} || echo "âš ï¸ Push failed (protected branch?)"
