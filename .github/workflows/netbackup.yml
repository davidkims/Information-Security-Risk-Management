name: NetBackup: Java Maven Server Backup

on:
  workflow_dispatch:

jobs:
  backup-java-maven-server:
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Maven ì„¤ì¹˜
      - name: Install Maven 3.9.6
        run: |
          MAVEN_VERSION=3.9.6
          curl -sL https://downloads.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.zip -o maven.zip
          unzip -q maven.zip -d $HOME/apache-maven
          echo "MAVEN_HOME=$HOME/apache-maven/apache-maven-${MAVEN_VERSION}" >> $GITHUB_ENV
          echo "PATH=$HOME/apache-maven/apache-maven-${MAVEN_VERSION}/bin:$PATH" >> $GITHUB_ENV

      # 3. í•„ìš”í•œ ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ (spring-petclinic ì˜ˆì‹œ)
      - name: Download project if missing
        run: |
          if [ ! -f "./pom.xml" ]; then
            echo "âš ï¸ pom.xml ì—†ìŒ â†’ ì˜ˆì œ í”„ë¡œì íŠ¸ ë‹¤ìš´ë¡œë“œ ì¤‘"
            curl -L -o springboot.zip "https://github.com/spring-projects/spring-petclinic/archive/refs/heads/main.zip"
            unzip -q springboot.zip -d temp-download
            mv temp-download/spring-petclinic-main/* ./
            echo "âœ… í”„ë¡œì íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          fi

      # 4. Maven ë¹Œë“œ (checkstyle ë¬´ì‹œ)
      - name: Build project (skip checkstyle)
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true

      # 5. ë””ìŠ¤í¬ ìŠ¬ë¡¯ ë””ë ‰í† ë¦¬ ìƒì„±
      - name: Create .netbackup slot
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          SLOT_DIR=".netbackup/slot-${TIMESTAMP}"
          echo "SLOT_DIR=${SLOT_DIR}" >> $GITHUB_ENV
          mkdir -p "${SLOT_DIR}/target" "${SLOT_DIR}/config"
          echo "ğŸ“ ë°±ì—… ìŠ¬ë¡¯ ë””ë ‰í† ë¦¬ ìƒì„±ë¨: ${SLOT_DIR}"

      # 6. ë°±ì—… íŒŒì¼ ë³µì‚¬
      - name: Backup project to .netbackup slot
        run: |
          cp pom.xml "${SLOT_DIR}/" || echo "âš ï¸ pom.xml ì—†ìŒ"
          [ -d src ] && cp -r src "${SLOT_DIR}/" || echo "âš ï¸ src ì—†ìŒ"
          [ -d target ] && cp target/*.jar "${SLOT_DIR}/target/" || echo "âš ï¸ target ë˜ëŠ” JAR ì—†ìŒ"
          [ -d src/main/resources ] && cp -r src/main/resources/* "${SLOT_DIR}/config/" || echo "âš ï¸ ì„¤ì • íŒŒì¼ ì—†ìŒ"
          echo "âœ… ë°±ì—… ì™„ë£Œ: ${SLOT_DIR}"

      # 7. Gitì— ë°±ì—… í‘¸ì‹œ
      - name: Commit and push .netbackup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .netbackup/
          git commit -m "ğŸ“¦ NetBackup: Maven backup on $(date +'%Y-%m-%d %H:%M:%S')" || echo "â„¹ï¸ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          git push || echo "â„¹ï¸ Git push ì‹¤íŒ¨ (ê¶Œí•œ ë˜ëŠ” ë³´í˜¸ ë¸Œëœì¹˜)"
